<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Test - Nova Crew Server</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #4fc3f7;
        }
        .test {
            background: #2d2d2d;
            border: 1px solid #404040;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .test h3 {
            margin-top: 0;
            color: #81c784;
        }
        .status {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
        }
        .success {
            background: #2e7d32;
            color: white;
        }
        .error {
            background: #c62828;
            color: white;
        }
        .info {
            background: #1565c0;
            color: white;
        }
        pre {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover {
            background: #1976d2;
        }
        #streamOutput {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            min-height: 100px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Nova Crew Server - Connection Test</h1>

    <div class="test">
        <h3>1. Proxy Health Check</h3>
        <button onclick="testProxyHealth()">Test Proxy (8081)</button>
        <button onclick="testBackendHealth()">Test Backend (8080)</button>
        <div id="healthStatus"></div>
    </div>

    <div class="test">
        <h3>2. Models Endpoint</h3>
        <button onclick="testModels()">Get Models</button>
        <div id="modelsStatus"></div>
    </div>

    <div class="test">
        <h3>3. Streaming Test</h3>
        <button onclick="testStreaming()">Test Streaming</button>
        <button onclick="stopStreaming()">Stop</button>
        <div id="streamStatus"></div>
        <div id="streamOutput"></div>
    </div>

    <div class="test">
        <h3>4. CORS Test</h3>
        <button onclick="testCORS()">Test CORS Headers</button>
        <div id="corsStatus"></div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const api = new CrewServerAPI();

        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            el.appendChild(div);
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testProxyHealth() {
            clear('healthStatus');
            log('healthStatus', 'ðŸ”„ Testing proxy on port 8081...', 'info');

            try {
                const response = await fetch('http://localhost:8081/health');
                const data = await response.json();

                if (data.status === 'ok') {
                    log('healthStatus', 'âœ“ Proxy is healthy!', 'success');
                    log('healthStatus', JSON.stringify(data, null, 2), 'info');
                } else {
                    log('healthStatus', 'âœ— Proxy returned unexpected status', 'error');
                }
            } catch (error) {
                log('healthStatus', `âœ— Proxy connection failed: ${error.message}`, 'error');
                log('healthStatus', 'Make sure to run: cd web/proxy && go run main.go', 'error');
            }
        }

        async function testBackendHealth() {
            clear('healthStatus');
            log('healthStatus', 'ðŸ”„ Testing backend on port 8080...', 'info');

            try {
                const response = await fetch('http://localhost:8080/health');
                const data = await response.json();

                if (data.status === 'ok') {
                    log('healthStatus', 'âœ“ Backend is healthy!', 'success');
                    log('healthStatus', JSON.stringify(data, null, 2), 'info');
                } else {
                    log('healthStatus', 'âœ— Backend returned unexpected status', 'error');
                }
            } catch (error) {
                log('healthStatus', `âœ— Backend connection failed: ${error.message}`, 'error');
                log('healthStatus', 'Make sure to run: go run main.go', 'error');
            }
        }

        async function testModels() {
            clear('modelsStatus');
            log('modelsStatus', 'ðŸ”„ Fetching models...', 'info');

            try {
                const models = await api.getModels();
                log('modelsStatus', 'âœ“ Models retrieved successfully!', 'success');

                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(models, null, 2);
                document.getElementById('modelsStatus').appendChild(pre);
            } catch (error) {
                log('modelsStatus', `âœ— Failed to get models: ${error.message}`, 'error');
            }
        }

        let isStreaming = false;

        async function testStreaming() {
            if (isStreaming) {
                log('streamStatus', 'âš  Already streaming', 'error');
                return;
            }

            clear('streamStatus');
            clear('streamOutput');
            isStreaming = true;

            log('streamStatus', 'ðŸ”„ Starting stream test...', 'info');

            const output = document.getElementById('streamOutput');
            let chunkCount = 0;

            try {
                await api.sendMessage(
                    "Say hello in one sentence",
                    // onChunk
                    (chunk, isComplete) => {
                        chunkCount++;
                        output.textContent += chunk;

                        if (isComplete) {
                            log('streamStatus', `âœ“ Stream completed! Received ${chunkCount} chunks`, 'success');
                            isStreaming = false;
                        }
                    },
                    // onNotification
                    (notification) => {
                        console.log('Notification:', notification);
                        log('streamStatus', `ðŸ”” Notification: ${notification.kind}`, 'info');
                    },
                    // onError
                    (error) => {
                        log('streamStatus', `âœ— Stream error: ${error.message}`, 'error');
                        isStreaming = false;
                    }
                );
            } catch (error) {
                log('streamStatus', `âœ— Failed to start stream: ${error.message}`, 'error');
                isStreaming = false;
            }
        }

        async function stopStreaming() {
            if (!isStreaming) {
                log('streamStatus', 'âš  No active stream', 'info');
                return;
            }

            log('streamStatus', 'ðŸ›‘ Stopping stream...', 'info');

            try {
                await api.stopCompletion();
                log('streamStatus', 'âœ“ Stream stopped', 'success');
                isStreaming = false;
            } catch (error) {
                log('streamStatus', `âœ— Failed to stop: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            clear('corsStatus');
            log('corsStatus', 'ðŸ”„ Testing CORS headers...', 'info');

            try {
                const response = await fetch('http://localhost:8081/health');
                const headers = {};

                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().includes('access-control')) {
                        headers[key] = value;
                    }
                });

                if (Object.keys(headers).length > 0) {
                    log('corsStatus', 'âœ“ CORS headers present!', 'success');

                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(headers, null, 2);
                    document.getElementById('corsStatus').appendChild(pre);
                } else {
                    log('corsStatus', 'âœ— No CORS headers found', 'error');
                    log('corsStatus', 'Make sure proxy is running on port 8081', 'error');
                }
            } catch (error) {
                log('corsStatus', `âœ— CORS test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run health check on load
        window.addEventListener('load', () => {
            console.log('ðŸ§ª Connection test page loaded');
            testProxyHealth();
        });
    </script>
</body>
</html>
